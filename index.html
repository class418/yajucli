<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>野獣先輩クリックゲーム</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<style>
  body {
    margin: 0; padding: 0;
    background: #282c34;
    color: #fff;
    font-family: Arial, sans-serif;
    height: 100vh;
    display: flex;
    overflow: hidden;
  }
  #leftPanel, #centerPanel, #rightPanel {
    padding: 10px;
    box-sizing: border-box;
    overflow-y: auto;
  }
  #leftPanel {
    flex: 1;
    background: #2a2f3a;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    position: relative;
  }
  #centerPanel {
    flex: 2;
    background: #333;
    display: flex;
    flex-wrap: wrap;
    gap: 2px;
    align-content: flex-start;
    position: relative;
  }
  #rightPanel {
    flex: 1;
    background: #222;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
  }
  #clickerBtn {
    width: 180px;
    height: 180px;
    border-radius: 15px;
    object-fit: contain;
    animation: spin 5s linear infinite;
    cursor: pointer;
    user-select: none;
    transition: transform 0.15s ease;
    -webkit-user-drag: none;
    margin-bottom: 10px;
  }
  #feverBtn {
    position: absolute;
    top: 50%;
    left: 50%;
    width: 80px;
    height: 80px;
    cursor: pointer;
    user-select: none;
    transform: translate(-50%, -50%);
    display: none;
    z-index: 10;
  }
  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }
  @keyframes spinFast {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }
  #scoreDisplay {
    font-size: 24px;
    margin-top: 5px;
    text-align: center;
    user-select: none;
  }
  #autoClickDisplay {
    position: absolute;
    top: 5px;
    background: rgba(0,0,0,0.4);
    padding: 2px 6px;
    border-radius: 6px;
    font-size: 14px;
    font-weight: bold;
    color: #ffeb3b;
    text-shadow: 0 0 4px #000;
    user-select: none;
  }
  .facilityIcon {
    width: 48px;
    height: 48px;
    object-fit: contain;
    -webkit-user-drag: none;
    user-select: none;
    margin: 0 1px 1px 0;
    position: relative;
  }
  .sectionTitle {
    font-weight: bold;
    margin: 10px 0 5px;
    border-bottom: 1px solid #555;
  }
  .buyButton {
    background: #444;
    border-radius: 8px;
    padding: 8px;
    margin-bottom: 8px;
    cursor: pointer;
    user-select: none;
  }
  .buyButton.disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  .buyButton:hover:not(.disabled) {
    background: #666;
  }
  body.fever {
    background: linear-gradient(45deg, #ffcc00, #ff0099);
    transition: background 0.5s;
  }
</style>
</head>
<body>

<div id="leftPanel">
  <div id="autoClickDisplay">自動0.0/秒</div>
  <img id="clickerBtn" src="/yajucli/assets/yajuu.png" alt="野獣先輩" draggable="false" />
  <div id="scoreDisplay">ポイント: 0</div>
  <input id="nameInput" type="text" placeholder="先輩の名前を入力（例：野獣）" style="margin-top:10px; width:160px; padding:4px; border-radius:6px; border:none; font-size:16px;"/>
</div>

<div id="centerPanel">
  <img id="feverBtn" src="/yajucli/assets/feverbtn.png" alt="フィーバーボタン" draggable="false" />
</div>

<div id="rightPanel">
  <div>
    <div class="sectionTitle">施設購入</div>
    <div id="facilityButtons"></div>
  </div>
  <div>
    <div class="sectionTitle">アップグレード</div>
    <div id="upgradeButtons"></div>
  </div>
</div>

<audio id="feverAudio" src="/yajucli/assets/fever.mp3" loop></audio>

<script>
let points = 0;
let clickPowerLevel = 0;
let autoClickLevel = 0;
let takuyaLevel = 0;

let feverActive = false;
let feverReady = true;
const feverDuration = 30000; // 30秒
const feverCooldown = 45000; // 45秒クールタイム

let debugMode = false;

const clickerBtn = document.getElementById('clickerBtn');
const scoreDisplay = document.getElementById('scoreDisplay');
const autoClickDisplay = document.getElementById('autoClickDisplay');
const facilityButtons = document.getElementById('facilityButtons');
const upgradeButtons = document.getElementById('upgradeButtons');
const centerPanel = document.getElementById('centerPanel');
const feverBtn = document.getElementById('feverBtn');
const feverAudio = document.getElementById('feverAudio');
const nameInput = document.getElementById('nameInput');

let autoClickInterval = null;

function calcPrice(base, level) {
  return Math.floor(base * Math.pow(1.15, level));
}

function pointsPerClick() {
  let base = 1 * (1 + 0.2 * clickPowerLevel);
  if (debugMode) base *= 10;
  if (feverActive) base *= 5;
  return base;
}

function autoClickPerSec() {
  let base = autoClickLevel * 0.1 + takuyaLevel * 1.0;
  if (debugMode) base *= 10;
  if (feverActive) base *= 5;
  return base;
}

function updateAutoClickDisplay() {
  autoClickDisplay.textContent = `自動${autoClickPerSec().toFixed(1)}/秒`;
}

function updateScore() {
  scoreDisplay.textContent = `ポイント: ${points.toFixed(1)}`;
  updateButtons();
  saveGame();
}

function addFacilityImages(src, count) {
  const maxPerRow = 10;
  const maxRows = 2;
  const showCount = Math.min(count, maxPerRow * maxRows);
  for(let i = 0; i < showCount; i++) {
    const img = document.createElement('img');
    img.src = src;
    img.classList.add('facilityIcon');
    centerPanel.appendChild(img);
  }
}

function addAllFacilities() {
  centerPanel.innerHTML = '';
  addFacilityImages('/yajucli/assets/cursor.png', autoClickLevel);
  addFacilityImages('/yajucli/assets/takuya.png', takuyaLevel);
  if (feverReady && !feverActive) {
    feverBtn.style.display = 'block';
  } else {
    feverBtn.style.display = 'none';
  }
}

function startAutoClick() {
  if (autoClickInterval) return;
  autoClickInterval = setInterval(() => {
    points += autoClickPerSec();
    updateScore();
  }, 1000);
}

const facilities = [
  { id:'cursor', name:'自動クリック', baseCost:10, level:0, icon:'/yajucli/assets/cursor.png',
    onBuy: function(){
      this.level++;
      autoClickLevel = this.level;
      addAllFacilities();
      updateAutoClickDisplay();
      if (autoClickLevel + takuyaLevel > 0) startAutoClick();
    }
  },
  { id:'takuya', name:'拓也さん', baseCost:100, level:0, icon:'/yajucli/assets/takuya.png',
    onBuy: function(){
      this.level++;
      takuyaLevel = this.level;
      addAllFacilities();
      updateAutoClickDisplay();
      if (autoClickLevel + takuyaLevel > 0) startAutoClick();
    }
  }
];

const upgrades = [
  { id:'clickPower', name:'クリック力強化', baseCost:50, level:0,
    onBuy:function(){
      this.level++;
      clickPowerLevel = this.level;
    }
  }
];

function createButtons() {
  facilities.forEach(f => {
    const btn = document.createElement('div');
    btn.id = 'facility-'+f.id;
    btn.classList.add('buyButton');
    facilityButtons.appendChild(btn);
  });
  upgrades.forEach(u => {
    const btn = document.createElement('div');
    btn.id = 'upgrade-'+u.id;
    btn.classList.add('buyButton');
    upgradeButtons.appendChild(btn);
  });
  updateButtons();
}

function updateButtons() {
  facilities.forEach(f => {
    const btn = document.getElementById('facility-'+f.id);
    const price = calcPrice(f.baseCost, f.level);
    btn.textContent = `${f.name} Lv.${f.level} - ${price}pt`;
    if (points >= price) {
      btn.classList.remove('disabled');
      btn.onclick = () => {
        if (points >= price) {
          points -= price;
          f.onBuy();
          updateScore();
        }
      };
    } else {
      btn.classList.add('disabled');
      btn.onclick = null;
    }
  });
  upgrades.forEach(u => {
    const btn = document.getElementById('upgrade-'+u.id);
    const price = calcPrice(u.baseCost, u.level);
    btn.textContent = `${u.name} Lv.${u.level} - ${price}pt`;
    if (points >= price) {
      btn.classList.remove('disabled');
      btn.onclick = () => {
        if (points >= price) {
          points -= price;
          u.onBuy();
          updateScore();
        }
      };
    } else {
      btn.classList.add('disabled');
      btn.onclick = null;
    }
  });
}

function playPuniAnimation() {
  clickerBtn.style.transform = 'scale(1.1,0.9)';
  setTimeout(() => clickerBtn.style.transform = 'scale(1,1)', 100);
}

function handleTap(e) {
  e.preventDefault();
  points += pointsPerClick();
  updateScore();
  playPuniAnimation();
}

clickerBtn.addEventListener('pointerdown', handleTap, { passive: false });

document.addEventListener('contextmenu', e => e.preventDefault());

function activateFever() {
  if (!feverReady || feverActive) return;

  feverActive = true;
  feverReady = false;

  document.body.classList.add('fever');
  clickerBtn.src = '/yajucli/assets/yajuu_fever.png';
  clickerBtn.style.animation = "spinFast 0.2s linear infinite";

  feverAudio.currentTime = 0;
  feverAudio.play();

  feverBtn.style.display = 'none';

  setTimeout(() => {
    feverActive = false;
    document.body.classList.remove('fever');
    clickerBtn.src = '/yajucli/assets/yajuu.png';
    clickerBtn.style.animation = "spin 5s linear infinite";

    feverAudio.pause();
    feverAudio.currentTime = 0;

    setTimeout(() => {
      feverReady = true;
      if (!debugMode) feverBtn.style.display = 'none';
      else feverBtn.style.display = 'block';
      saveGame();
    }, feverCooldown);
    saveGame();
  }, feverDuration);
  saveGame();
}

feverBtn.addEventListener('click', () => {
  activateFever();
});

function randomFeverBtnShow() {
  if (feverActive) {
    feverBtn.style.display = 'none';
    return;
  }
  if (debugMode) {
    feverBtn.style.display = 'block';
    return;
  }
  if (!feverReady) {
    feverBtn.style.display = 'none';
    return;
  }
  if (Math.random() < 0.05) {
    feverBtn.style.display = 'block';
  } else {
    feverBtn.style.display = 'none';
  }
}

// 名前変更とデバッグモード判定
function onNameChange() {
  let name = nameInput.value.trim() || "野獣";
  nameInput.value = name; // 空白消すため
  document.title = `${name}先輩クリックゲーム`;
  clickerBtn.alt = `${name}先輩`;

  debugMode = (name === "デバッグ先輩");
  if (debugMode) {
    feverBtn.style.display = 'block';
  } else {
    feverBtn.style.display = feverReady && !feverActive ? 'block' : 'none';
  }
  updateScore();
  updateAutoClickDisplay();
  saveGame();
}

nameInput.addEventListener('input', onNameChange);

// セーブ・ロード処理
function saveGame() {
  const saveData = {
    points,
    clickPowerLevel,
    autoClickLevel,
    takuyaLevel,
    name: nameInput.value.trim() || "野獣",
    feverReady,
    feverActive,
  };
  localStorage.setItem('yajuClickerSave', JSON.stringify(saveData));
}

function loadGame() {
  const saved = localStorage.getItem('yajuClickerSave');
  if (!saved) return;
  try {
    const data = JSON.parse(saved);
    points = data.points || 0;
    clickPowerLevel = data.clickPowerLevel || 0;
    autoClickLevel = data.autoClickLevel || 0;
    takuyaLevel = data.takuyaLevel || 0;
    feverReady = (typeof data.feverReady === 'boolean') ? data.feverReady : true;
    feverActive = (typeof data.feverActive === 'boolean') ? data.feverActive : false;

    // 先輩名
    if (data.name) {
      nameInput.value = data.name;
      onNameChange();
    }

    updateScore();
    updateAutoClickDisplay();
    addAllFacilities();

    // フィーバー中だったら復帰させる（少し不完全かも）
    if (feverActive) {
      activateFever();
    }
  } catch(e) {
    console.error('セーブデータ読み込み失敗', e);
  }
}

// フィーバーボタンの表示管理タイマー
setInterval(randomFeverBtnShow, 3000);

// 初期化
window.addEventListener('load', () => {
  loadGame();
  createButtons();
  updateScore();
  updateAutoClickDisplay();
  addAllFacilities();
  if (autoClickLevel + takuyaLevel > 0) startAutoClick();
});
</script>

</body>
</html>
