<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>野獣先輩クリックゲーム</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<style>
  body {
    margin: 0; padding: 0;
    background: #282c34;
    color: #fff;
    font-family: Arial, sans-serif;
    height: 100vh;
    display: flex;
    overflow: hidden;
  }
  #leftPanel, #centerPanel, #rightPanel {
    padding: 10px;
    box-sizing: border-box;
    overflow-y: auto;
  }
  #leftPanel {
    flex: 1;
    background: #2a2f3a;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    position: relative;
  }
  #centerPanel {
    flex: 2;
    background: #333;
    display: flex;
    flex-wrap: wrap;
    gap: 2px;
    align-content: flex-start;
  }
  #rightPanel {
    flex: 1;
    background: #222;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
  }
  #clickerBtn {
    width: 180px;
    height: 180px;
    border-radius: 15px;
    object-fit: contain;
    animation: spin 5s linear infinite;
    cursor: pointer;
    user-select: none;
    transition: transform 0.15s ease;
    -webkit-user-drag: none;
    margin-bottom: 10px;
  }
  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }
  #scoreDisplay {
    font-size: 24px;
    margin-top: 5px;
    text-align: center;
    user-select: none;
  }
  #autoClickDisplay {
    position: absolute;
    top: 5px;
    background: rgba(0,0,0,0.4);
    padding: 2px 6px;
    border-radius: 6px;
    font-size: 14px;
    font-weight: bold;
    color: #ffeb3b;
    text-shadow: 0 0 4px #000;
    user-select: none;
  }
  .facilityIcon {
    width: 48px;
    height: 48px;
    object-fit: contain;
    -webkit-user-drag: none;
    user-select: none;
    margin: 0 1px 1px 0;
    position: relative;
  }
  .sectionTitle {
    font-weight: bold;
    margin: 10px 0 5px;
    border-bottom: 1px solid #555;
  }
  .buyButton {
    background: #444;
    border-radius: 8px;
    padding: 8px;
    margin-bottom: 8px;
    cursor: pointer;
    user-select: none;
  }
  .buyButton.disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  .buyButton:hover:not(.disabled) {
    background: #666;
  }
</style>
</head>
<body>

<div id="leftPanel">
  <div id="autoClickDisplay">自動0.0/秒</div>
  <img id="clickerBtn" src="/yajucli/assets/yajuu.png" alt="野獣先輩" draggable="false" />
  <div id="scoreDisplay">ポイント: 0</div>
</div>

<div id="centerPanel">
  <!-- 購入した施設アイコンがここに横に並びます -->
</div>

<div id="rightPanel">
  <div>
    <div class="sectionTitle">施設購入</div>
    <div id="facilityButtons"></div>
  </div>
  <div>
    <div class="sectionTitle">アップグレード</div>
    <div id="upgradeButtons"></div>
  </div>
</div>

<script>
let points = 0;
let clickPowerLevel = 0;
let autoClickLevel = 0;
let takuyaLevel = 0;

const clickerBtn = document.getElementById('clickerBtn');
const scoreDisplay = document.getElementById('scoreDisplay');
const autoClickDisplay = document.getElementById('autoClickDisplay');
const facilityButtons = document.getElementById('facilityButtons');
const upgradeButtons = document.getElementById('upgradeButtons');
const centerPanel = document.getElementById('centerPanel');

let autoClickInterval = null;
const AudioContext = window.AudioContext || window.webkitAudioContext;
let audioCtx = null;
let clickBuffer = null;

function initAudioContext() {
  if (!audioCtx) audioCtx = new AudioContext();
}
function loadClickSound() {
  fetch('/yajucli/assets/click.mp3')
    .then(r => r.arrayBuffer())
    .then(buf => audioCtx.decodeAudioData(buf))
    .then(decoded => clickBuffer = decoded);
}
function playClickSound() {
  if (!clickBuffer || !audioCtx) return;
  const src = audioCtx.createBufferSource();
  src.buffer = clickBuffer;
  src.connect(audioCtx.destination);
  src.start();
}

function calcPrice(base, level) {
  return Math.floor(base * Math.pow(1.15, level));
}
function pointsPerClick() {
  return 1 * (1 + 0.2 * clickPowerLevel);
}
function autoClickPerSec() {
  return autoClickLevel * 0.1 + takuyaLevel * 1.0;
}
function updateAutoClickDisplay() {
  autoClickDisplay.textContent = `自動${autoClickPerSec().toFixed(1)}/秒`;
}
function updateScore() {
  scoreDisplay.textContent = `ポイント: ${points.toFixed(1)}`;
  updateButtons();
}

// 施設アイコンは最大2列まで表示、3列目は描画しない（JavaScriptで制御）
function addFacilityImages(src, count) {
  centerPanel.innerHTML = '';

  const maxPerRow = 10; 
  const maxRows = 2;

  const showCount = Math.min(count, maxPerRow * maxRows);

  for(let i = 0; i < showCount; i++) {
    const img = document.createElement('img');
    img.src = src;
    img.classList.add('facilityIcon');
    centerPanel.appendChild(img);
  }
}

function startAutoClick() {
  if (autoClickInterval) return;
  autoClickInterval = setInterval(() => {
    points += autoClickPerSec();
    updateScore();
    playClickSound();
  }, 1000);
}

const facilities = [
  { id:'cursor', name:'自動クリック', baseCost:10, level:0, icon:'/yajucli/assets/cursor.png',
    onBuy: function(){
      this.level++;
      autoClickLevel = this.level;
      addAllFacilities();
      updateAutoClickDisplay();
      if (autoClickLevel + takuyaLevel > 0) startAutoClick();
    }
  },
  { id:'takuya', name:'拓也さん', baseCost:100, level:0, icon:'/yajucli/assets/takuya.png',
    onBuy: function(){
      this.level++;
      takuyaLevel = this.level;
      addAllFacilities();
      updateAutoClickDisplay();
      if (autoClickLevel + takuyaLevel > 0) startAutoClick();
    }
  }
];
const upgrades = [
  { id:'clickPower', name:'クリック力強化', baseCost:50, level:0,
    onBuy:function(){
      this.level++;
      clickPowerLevel = this.level;
    }
  }
];

function addAllFacilities() {
  centerPanel.innerHTML = '';
  addFacilityImages('/yajucli/assets/cursor.png', autoClickLevel);
  addFacilityImages('/yajucli/assets/takuya.png', takuyaLevel);
}

function createButtons() {
  facilities.forEach(f => {
    const btn = document.createElement('div');
    btn.id = 'facility-'+f.id;
    btn.classList.add('buyButton');
    facilityButtons.appendChild(btn);
  });
  upgrades.forEach(u => {
    const btn = document.createElement('div');
    btn.id = 'upgrade-'+u.id;
    btn.classList.add('buyButton');
    upgradeButtons.appendChild(btn);
  });
  updateButtons();
}

function updateButtons() {
  facilities.forEach(f => {
    const btn = document.getElementById('facility-'+f.id);
    const price = calcPrice(f.baseCost, f.level);
    btn.textContent = `${f.name} Lv.${f.level} - ${price}pt`;
    if (points >= price) {
      btn.classList.remove('disabled');
      btn.onclick = () => {
        if (points >= price) {
          points -= price;
          f.onBuy();
          updateScore();
          saveGame();
        }
      };
    } else {
      btn.classList.add('disabled');
      btn.onclick = null;
    }
  });
  upgrades.forEach(u => {
    const btn = document.getElementById('upgrade-'+u.id);
    const price = calcPrice(u.baseCost, u.level);
    btn.textContent = `${u.name} Lv.${u.level} - ${price}pt`;
    if (points >= price) {
      btn.classList.remove('disabled');
      btn.onclick = () => {
        if (points >= price) {
          points -= price;
          u.onBuy();
          updateScore();
          saveGame();
        }
      };
    } else {
      btn.classList.add('disabled');
      btn.onclick = null;
    }
  });
}

function playPuniAnimation() {
  clickerBtn.style.transform = 'scale(1.1,0.9)';
  setTimeout(()=>clickerBtn.style.transform = 'scale(1,1)',100);
}

function handleTap(e) {
  e.preventDefault();
  initAudioContext();
  if (audioCtx.state === 'suspended') audioCtx.resume();
  points += pointsPerClick();
  updateScore();
  playClickSound();
  playPuniAnimation();
  saveGame();
}

clickerBtn.addEventListener('pointerdown', handleTap, { passive: false });

document.addEventListener('contextmenu', e => e.preventDefault());

// --------- データセーブ・ロード ---------

function getSaveData() {
  return {
    points,
    clickPowerLevel,
    autoClickLevel,
    takuyaLevel,
    facilities: facilities.map(f => f.level),
    upgrades: upgrades.map(u => u.level),
  };
}

function saveGame() {
  try {
    const data = getSaveData();
    localStorage.setItem('yajuClickerSave', JSON.stringify(data));
  } catch (e) {
    console.error('セーブ失敗:', e);
  }
}

function loadGame() {
  const saved = localStorage.getItem('yajuClickerSave');
  if (!saved) return;

  try {
    const data = JSON.parse(saved);

    points = data.points || 0;
    clickPowerLevel = data.clickPowerLevel || 0;
    autoClickLevel = data.autoClickLevel || 0;
    takuyaLevel = data.takuyaLevel || 0;

    if (data.facilities && Array.isArray(data.facilities)) {
      facilities.forEach((f, i) => {
        f.level = data.facilities[i] || 0;
      });
      autoClickLevel = facilities.find(f => f.id === 'cursor')?.level || 0;
      takuyaLevel = facilities.find(f => f.id === 'takuya')?.level || 0;
    }

    if (data.upgrades && Array.isArray(data.upgrades)) {
      upgrades.forEach((u, i) => {
        u.level = data.upgrades[i] || 0;
      });
      clickPowerLevel = upgrades.find(u => u.id === 'clickPower')?.level || 0;
    }
  } catch (e) {
    console.error('ロード失敗:', e);
  }
}

window.addEventListener('load', () => {
  initAudioContext();
  loadClickSound();
  loadGame();
  updateAutoClickDisplay();
  createButtons();
  addAllFacilities();
  updateScore();
  if (autoClickLevel + takuyaLevel > 0) startAutoClick();
});

</script>

</body>
</html>
